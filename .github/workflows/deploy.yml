name: Deploy All Instances
# on:
#   workflow_dispatch:

on:
  push:
    branches:
      - feat/continuous-deploy

jobs:
  deploy-latest:
    # You need to use the INSTALLATION_NAME from the previous step
    runs-on: arc-runner-set
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: Assume Role
      uses: aws-actions/configure-aws-credentials@v4
      with:
        output-credentials: true
        aws-region: us-east-1
    - name: Get secrets by name and by ARN
      uses: aws-actions/aws-secretsmanager-get-secrets@v1
      with:
        parse-json-secrets: true
        secret-ids: |
          hoop/self-hosted/appdemo
    - run: |-
        ( echo "cat <<EOF" ; cat ./infra/appdemo/values.yml ; echo EOF ) | sh > ./appdemo-values.yml
    - name: Upgrade App Demo
      run: |-
        VERSION=$(curl -s https://hoopartifacts.s3.amazonaws.com/release/latest.txt)
        helm upgrade --install hoop https://hoopartifacts.s3.amazonaws.com/release/$VERSION/hoop-chart-$VERSION.tgz \
          -f ./appdemo-values.yml \
          --set gw.image.tag=$VERSION \
          -n appdemo

