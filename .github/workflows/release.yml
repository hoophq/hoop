name: Release

# on:
#   push:
#     tags:
#     - '[0-9]+.[0-9]+.[0-9]+'

on:
  push

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout Hoop
        uses: actions/checkout@v3

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '>=1.20.0'
          cache-dependency-path: '**/go.sum'

      - name: Test
        run: make test

  build-amd64:
    runs-on: ubuntu-latest
    name: build-amd64
    environment: production
    needs: [test]

    steps:
      - name: Install GoReleaser
        uses: goreleaser/goreleaser-action@v3
        with:
          install-only: true
          distribution: goreleaser
          version: latest

      - name: Set Git Tag
        run: echo "GIT_TAG=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV

      - name: amd64
        env:
          GIT_TAG: ${{ env.GIT_TAG }}
        run: GOOS=darwin GOARCH=amd64 goreleaser build --single-target --id hoop --snapshot

      - uses: actions/upload-artifact@v3
        with:
          name: amd64
          path: dist/

  build-arm64:
    runs-on: ubuntu-latest
    name: build-arm64
    environment: production
    needs: [test]

    steps:
      - name: Install GoReleaser
        uses: goreleaser/goreleaser-action@v3
        with:
          install-only: true
          distribution: goreleaser
          version: latest

      - name: Set Git Tag
        run: echo "GIT_TAG=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV

      - name: amd64
        env:
          GIT_TAG: ${{ env.GIT_TAG }}
        run: GOOS=darwin GOARCH=arm64 goreleaser build --single-target --id hoop --snapshot

      - uses: actions/upload-artifact@v3
        with:
          name: arm64
          path: dist/

