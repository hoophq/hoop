name: Release

# on:
#   push:
#     tags:
#     - '[0-9]+.[0-9]+.[0-9]+'

on:
  push

jobs:
  publish:
    name: Publish Release
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout Hoop
        uses: actions/checkout@v3

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '>=1.20.0'
          cache-dependency-path: '**/go.sum'

      - name: Test
        run: make test

      - name: Install GoReleaser
        uses: goreleaser/goreleaser-action@v3
        with:
          install-only: true
          distribution: goreleaser
          version: latest

      # - name: Checkout Webapp
      #   uses: actions/checkout@v3
      #   with:
      #     repository: runopsio/webapp
      #     token: ${{ secrets.GH_TOKEN }}
      #     path: './build/webapp'

      # - name: Checkout Helm Chart
      #   uses: actions/checkout@v3
      #   with:
      #     repository: hoophq/helm-chart
      #     path: './build/helm-chart'
      
      # - name: Setup Java
      #   uses: actions/setup-java@v2
      #   with:
      #     distribution: 'zulu'
      #     java-version: '11'

      # - name: Setup Node
      #   uses: actions/setup-node@v3
      #   with:
      #     node-version: 16

      # - name: Setup Helm3
      #   uses: azure/setup-helm@v3

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v2
        with:
          platforms: 'linux/amd64,linux/arm64'

      - name: Docker Login
        run: docker login -u=${{ secrets.DOCKER_LOGIN }} -p=${{ secrets.DOCKER_PASSWORD }}

      - name: Set Git Tag
        run: echo "GIT_TAG=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV

      - name: Publish Release
        env:
          GIT_TAG: ${{ env.GIT_TAG }}
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          AWS_REGION: us-east-1
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: goreleaser release --snapshot
